#include <Arduino.h>
#include "BluetoothSerial.h"

#define DAC_CH1 25
#define LED1  18
#define LED2  19

int raw = 0;
unsigned long tinicio,tactual = 0; // Variable para almacenar el tiempo anterior
const long periodo = 15; // Intervalo en milisegundos

String device_name = "ESP32_BLUETOOTH";

BluetoothSerial SerialBT;

String Serialdata = "";
bool dataflag = 0;
String comando = "";
int leds[] = {18,19};

void inicia_leds(void);


void dientedesierra();

void setup() {
  inicia_leds();
  Serial.begin(115200);
  SerialBT.begin(device_name); //Bluetooth device name
  Serial.printf("El dispositivo \"%s\" esta listo para emparejar\n", device_name.c_str());
  
}

void loop() {
  // Obtener el tiempo actual
  tactual = millis();
  dientedesierra();
  //cuando hay algo para transmitir a bluetooth se hace!!!
  if (dataflag == 1)
  {
    SerialBT.print(Serialdata);
    Serialdata = "";
    dataflag = 0;
  }

  //aqui se revisa si algo ha llegado desde el bluetooth.
  if (SerialBT.available() != 0)
  {
    while (SerialBT.available() != 0)
    {
      //lee cada caracter que se recibe via bluettoth
      comando = comando + char(SerialBT.read());
    }
    //analiza el string recibido para tomar acción
    if(comando.equals("led_on2")){
      digitalWrite(LED2,HIGH);
      Serial.println("Encendido el LED18");
      SerialBT.print("Encendido el LED18");
    }else if(comando.equals("led_off2")){
      digitalWrite(LED2,LOW);
      Serial.println("El LED19 ha sido apagado");
      SerialBT.print("El LED19 ha sido apagado");
    }
    if(comando.equals("led_on")){
      digitalWrite(LED1,HIGH);
      Serial.println("Encendido el LED18");
      SerialBT.print("Encendido el LED18");
    }else if(comando.equals("led_off")){
      digitalWrite(LED1,LOW);
      Serial.println("El LED18 ha sido apagado");
      SerialBT.print("El LED18 ha sido apagado");
    }
      Serial.println(comando);
      comando="";
  }  

}

void dientedesierra(void){
  // Comparar el tiempo actual con el tiempo anterior
  if (tactual - tinicio >= periodo) {
    // Guardar el tiempo actual como el último tiempo de muestreo
    tinicio = tactual;
    // Escribir el valor actual al DAC
    dacWrite(DAC_CH1, raw);
    // Incrementar el valor
    raw++;
    // Resetear el valor si supera 255
    if (raw > 255) {
      raw = 0;
    }
  }
}

void inicia_leds(void){
  u_int8_t i;
  for(i=0;i<2;++i){
    pinMode(leds[i],OUTPUT);
    digitalWrite(leds[i],LOW);
    }
}
void serialEvent() {
  while (Serial.available()) {
    Serialdata = String(Serialdata + char(Serial.read()));
    dataflag = 1;
  }
}
